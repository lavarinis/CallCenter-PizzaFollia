import _defineProperty from"@babel/runtime/helpers/defineProperty";import _objectWithoutProperties from"@babel/runtime/helpers/objectWithoutProperties";import _classCallCheck from"@babel/runtime/helpers/classCallCheck";import _createClass from"@babel/runtime/helpers/createClass";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(source,true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(source).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}import{normalizeSharedElementsConfig}from'./utils';function getSharedElements(sceneData,otherSceneData,showing){var sharedElements=sceneData.Component.sharedElements;if(!sharedElements)return null;return normalizeSharedElementsConfig(sharedElements(sceneData.navigation,otherSceneData.navigation,showing));}var NO_SHARED_ELEMENTS=[];var SharedElementRendererData=function(){function SharedElementRendererData(){_classCallCheck(this,SharedElementRendererData);this.scenes=[];this.updateSubscribers=new Set();this.sharedElements=null;this.isShowing=true;this.route=null;this.prevRoute=null;this.scene=null;this.prevScene=null;}_createClass(SharedElementRendererData,[{key:"startTransition",value:function startTransition(animValue,route,prevRoute){this.animValue=animValue;this.prevRoute=this.route;this.route=route;this.updateSceneListeners();this.updateSharedElements();}},{key:"endTransition",value:function endTransition(route,prevRoute){if(this.prevRoute!=null){this.prevRoute=null;this.animValue=null;this.updateSceneListeners();this.updateSharedElements();}}},{key:"willActivateScene",value:function willActivateScene(sceneData,route){this.registerScene(sceneData,route);}},{key:"didActivateScene",value:function didActivateScene(sceneData,route){this.route=route;this.prevRoute=null;this.registerScene(sceneData,route);}},{key:"registerScene",value:function registerScene(sceneData,route){this.scenes.push({scene:sceneData,route:route,subscription:null});if(this.scenes.length>5){var subscription=this.scenes[0].subscription;this.scenes.splice(0,1);if(subscription)subscription.remove();}this.updateSceneListeners();this.updateSharedElements();}},{key:"updateSceneListeners",value:function updateSceneListeners(){var _this=this;this.scenes.forEach(function(sceneRoute){var scene=sceneRoute.scene,route=sceneRoute.route,subscription=sceneRoute.subscription;var isActive=_this.route&&_this.route.key===route.key||_this.prevRoute&&_this.prevRoute.key===route.key;if(isActive&&!subscription){sceneRoute.subscription=scene.addUpdateListener(function(){_this.emitUpdateEvent();});}else if(!isActive&&subscription){sceneRoute.subscription=null;subscription.remove();}});}},{key:"updateSharedElements",value:function updateSharedElements(){var route=this.route,prevRoute=this.prevRoute,animValue=this.animValue;var sceneRoute=route?this.scenes.find(function(sc){return sc.route.key===route.key;}):undefined;var prevSceneRoute=prevRoute?this.scenes.find(function(sc){return sc.route.key===prevRoute.key;}):undefined;var scene=sceneRoute?sceneRoute.scene:null;var prevScene=prevSceneRoute?prevSceneRoute.scene:null;if(scene===this.scene&&prevScene===this.prevScene)return;this.scene=scene;this.prevScene=prevScene;var sharedElements=null;var isShowing=true;if(animValue&&scene&&prevScene){sharedElements=getSharedElements(scene,prevScene,true);if(!sharedElements){isShowing=false;sharedElements=getSharedElements(prevScene,scene,false);}}if(this.sharedElements!==sharedElements){this.sharedElements=sharedElements;this.isShowing=isShowing;this.emitUpdateEvent();}}},{key:"addUpdateListener",value:function addUpdateListener(handler){var _this2=this;this.updateSubscribers.add(handler);return{remove:function remove(){return _this2.updateSubscribers.delete(handler);}};}},{key:"emitUpdateEvent",value:function emitUpdateEvent(){this.updateSubscribers.forEach(function(handler){return handler();});}},{key:"getTransitions",value:function getTransitions(){var sharedElements=this.sharedElements,prevScene=this.prevScene,scene=this.scene,isShowing=this.isShowing,animValue=this.animValue;if(!sharedElements||!scene||!prevScene)return NO_SHARED_ELEMENTS;return sharedElements.map(function(_ref){var id=_ref.id,otherId=_ref.otherId,other=_objectWithoutProperties(_ref,["id","otherId"]);var startId=isShowing?otherId||id:id;var endId=isShowing?id:otherId||id;return _objectSpread({position:animValue,start:{ancestor:(prevScene?prevScene.getAncestor():undefined)||null,node:(prevScene?prevScene.getNode(startId):undefined)||null},end:{ancestor:(scene?scene.getAncestor():undefined)||null,node:(scene?scene.getNode(endId):undefined)||null}},other);});}}]);return SharedElementRendererData;}();export{SharedElementRendererData as default};
//# sourceMappingURL=SharedElementRendererData.js.map